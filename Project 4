# playstore_rating.py
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.preprocessing import OneHotEncoder
from sklearn.metrics import mean_squared_error, r2_score
from scipy.sparse import hstack

df = pd.read_csv("googleplaystore.csv")  # replace path
# Basic cleaning
df = df[df['Rating'].notna()]  # drop unknown ratings for training
df = df.sample(frac=1, random_state=42)  # shuffle

# Convert installs to numeric
df['Installs'] = df['Installs'].str.replace('[+,]', '', regex=True).astype(float)

# Price
df['Price'] = df['Price'].str.replace('[$]', '', regex=True).astype(float)

# Size: convert 'M' and 'k' etc.
def parse_size(s):
    try:
        if s.endswith('M'):
            return float(s[:-1])
        if s.endswith('k'):
            return float(s[:-1]) / 1024
        if s == 'Varies with device' or s == 'NaN' or pd.isna(s):
            return np.nan
        return float(s)
    except:
        return np.nan

df['SizeMB'] = df['Size'].fillna('0').apply(parse_size).fillna(df['Size'].median())

# Text TF-IDF
tfidf = TfidfVectorizer(max_features=2000, stop_words='english')
desc = df['Description'].fillna('')  # might be large - consider truncated descriptions
X_text = tfidf.fit_transform(desc)

# Categorical features
cat_feats = ['Category', 'Content Rating']
ohe = OneHotEncoder(handle_unknown='ignore', sparse=True)
X_cat = ohe.fit_transform(df[cat_feats].fillna('Unknown'))

# Numeric features
num_feats = df[['Installs','Price','Reviews','SizeMB']].fillna(0)
X_num = num_feats.values

# Combine
X = hstack([X_text, X_cat, X_num])
y = df['Rating'].values

# Train/test
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Model
model = RandomForestRegressor(n_estimators=150, n_jobs=-1, random_state=42)
model.fit(X_train, y_train)

# Predict + eval
y_pred = model.predict(X_test)
rmse = mean_squared_error(y_test, y_pred, squared=False)
r2 = r2_score(y_test, y_pred)
print(f"RMSE: {rmse:.4f}, R2: {r2:.4f}")

# Example: predict for a new app (create feature vector accordingly)
